-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.analytics_events (
  id uuid NOT NULL,
  user_id uuid,
  device_id character varying,
  session_id character varying,
  event_name character varying NOT NULL,
  entity_type character varying,
  entity_id uuid,
  metadata json,
  context json,
  occurred_at timestamp without time zone,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT analytics_events_pkey PRIMARY KEY (id),
  CONSTRAINT analytics_events_user_id_foreign FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.booking_passengers (
  id uuid NOT NULL,
  booking_id uuid NOT NULL,
  type character varying NOT NULL,
  full_name character varying NOT NULL,
  gender character varying,
  date_of_birth date,
  document_number character varying,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT booking_passengers_pkey PRIMARY KEY (id),
  CONSTRAINT booking_passengers_booking_id_foreign FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.booking_promotions (
  booking_id uuid NOT NULL,
  promotion_id uuid NOT NULL,
  discount_amount numeric NOT NULL DEFAULT '0'::numeric,
  discount_type character varying,
  applied_value numeric,
  CONSTRAINT booking_promotions_pkey PRIMARY KEY (booking_id, promotion_id),
  CONSTRAINT booking_promotions_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT booking_promotions_promotion_id_fkey FOREIGN KEY (promotion_id) REFERENCES public.promotions(id)
);
CREATE TABLE public.bookings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  tour_schedule_id uuid,
  booking_date timestamp without time zone DEFAULT now(),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'cancelled'::text, 'completed'::text])),
  total_price numeric,
  payment_status text DEFAULT 'unpaid'::text CHECK (payment_status = ANY (ARRAY['pending'::text, 'unpaid'::text, 'paid'::text, 'refunded'::text])),
  package_id uuid,
  total_adults integer NOT NULL DEFAULT 0,
  total_children integer NOT NULL DEFAULT 0,
  contact_name character varying,
  contact_email character varying,
  contact_phone character varying,
  notes text,
  created_at timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT bookings_pkey PRIMARY KEY (id),
  CONSTRAINT bookings_tour_schedule_id_fkey FOREIGN KEY (tour_schedule_id) REFERENCES public.tour_schedules(id),
  CONSTRAINT bookings_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT bookings_package_id_foreign FOREIGN KEY (package_id) REFERENCES public.tour_packages(id)
);
CREATE TABLE public.cancellation_policies (
  id uuid NOT NULL,
  tour_id uuid NOT NULL,
  days_before integer NOT NULL,
  refund_rate numeric NOT NULL,
  description character varying,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT cancellation_policies_pkey PRIMARY KEY (id),
  CONSTRAINT cancellation_policies_tour_id_foreign FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.cart_items (
  id uuid NOT NULL,
  cart_id uuid NOT NULL,
  tour_id uuid NOT NULL,
  schedule_id uuid,
  package_id uuid,
  adult_quantity integer NOT NULL DEFAULT 0,
  child_quantity integer NOT NULL DEFAULT 0,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT cart_items_pkey PRIMARY KEY (id),
  CONSTRAINT cart_items_cart_id_foreign FOREIGN KEY (cart_id) REFERENCES public.carts(id),
  CONSTRAINT cart_items_tour_id_foreign FOREIGN KEY (tour_id) REFERENCES public.tours(id),
  CONSTRAINT cart_items_schedule_id_foreign FOREIGN KEY (schedule_id) REFERENCES public.tour_schedules(id),
  CONSTRAINT cart_items_package_id_foreign FOREIGN KEY (package_id) REFERENCES public.tour_packages(id)
);
CREATE TABLE public.carts (
  id uuid NOT NULL,
  user_id uuid NOT NULL,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT carts_pkey PRIMARY KEY (id),
  CONSTRAINT carts_user_id_foreign FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  parent_id uuid,
  CONSTRAINT categories_pkey PRIMARY KEY (id),
  CONSTRAINT categories_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.categories(id)
);
CREATE TABLE public.failed_jobs (
  id bigint NOT NULL DEFAULT nextval('failed_jobs_id_seq'::regclass),
  uuid character varying NOT NULL UNIQUE,
  connection text NOT NULL,
  queue text NOT NULL,
  payload text NOT NULL,
  exception text NOT NULL,
  failed_at timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT failed_jobs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.invoices (
  id uuid NOT NULL,
  booking_id uuid NOT NULL UNIQUE,
  partner_id uuid NOT NULL,
  invoice_number character varying NOT NULL UNIQUE,
  status character varying NOT NULL DEFAULT 'issued'::character varying,
  currency character varying NOT NULL DEFAULT 'VND'::character varying,
  subtotal numeric NOT NULL,
  tax_amount numeric NOT NULL,
  total numeric NOT NULL,
  vat_rate numeric NOT NULL DEFAULT '10'::numeric,
  customer_name character varying NOT NULL,
  customer_tax_code character varying,
  customer_address character varying,
  customer_email character varying,
  issued_at timestamp without time zone NOT NULL,
  file_path character varying NOT NULL,
  line_items json NOT NULL,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  delivery_method character varying NOT NULL DEFAULT 'download'::character varying,
  emailed_at timestamp without time zone,
  CONSTRAINT invoices_pkey PRIMARY KEY (id),
  CONSTRAINT invoices_booking_id_foreign FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT invoices_partner_id_foreign FOREIGN KEY (partner_id) REFERENCES public.partners(id)
);
CREATE TABLE public.migrations (
  id integer NOT NULL DEFAULT nextval('migrations_id_seq'::regclass),
  migration character varying NOT NULL,
  batch integer NOT NULL,
  CONSTRAINT migrations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL,
  notifiable_type character varying NOT NULL,
  notifiable_id uuid NOT NULL,
  type character varying NOT NULL,
  data json NOT NULL,
  read_at timestamp without time zone,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT notifications_pkey PRIMARY KEY (id)
);
CREATE TABLE public.partners (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  company_name text NOT NULL,
  tax_code text,
  address text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text])),
  created_at timestamp without time zone DEFAULT now(),
  invoice_company_name character varying,
  invoice_tax_code character varying,
  invoice_address character varying,
  invoice_email character varying,
  invoice_vat_rate numeric NOT NULL DEFAULT '10'::numeric,
  contact_name character varying,
  contact_email character varying,
  contact_phone character varying,
  business_type character varying,
  description text,
  approved_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT partners_pkey PRIMARY KEY (id),
  CONSTRAINT partners_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.password_resets (
  email character varying NOT NULL,
  token character varying NOT NULL,
  created_at timestamp without time zone,
  phone character varying,
  CONSTRAINT password_resets_pkey PRIMARY KEY (email)
);
CREATE TABLE public.payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  booking_id uuid,
  method text,
  amount numeric,
  tax numeric DEFAULT 0,
  total_amount numeric DEFAULT (amount + COALESCE(tax, (0)::numeric)),
  invoice_number text UNIQUE,
  transaction_code text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'success'::text, 'failed'::text, 'refunded'::text])),
  paid_at timestamp without time zone,
  refund_amount numeric,
  CONSTRAINT payments_pkey PRIMARY KEY (id),
  CONSTRAINT payments_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.personal_access_tokens (
  id bigint NOT NULL DEFAULT nextval('personal_access_tokens_id_seq'::regclass),
  tokenable_type character varying NOT NULL,
  tokenable_id uuid NOT NULL,
  name character varying NOT NULL,
  token character varying NOT NULL UNIQUE,
  abilities text,
  last_used_at timestamp without time zone,
  expires_at timestamp without time zone,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT personal_access_tokens_pkey PRIMARY KEY (id)
);
CREATE TABLE public.promotion_assignments (
  id uuid NOT NULL,
  promotion_id uuid NOT NULL,
  user_id uuid,
  voucher_code character varying NOT NULL UNIQUE,
  status character varying NOT NULL DEFAULT 'issued'::character varying CHECK (status::text = ANY (ARRAY['issued'::character varying, 'redeemed'::character varying, 'cancelled'::character varying, 'expired'::character varying]::text[])),
  expires_at timestamp without time zone,
  redeemed_at timestamp without time zone,
  booking_id uuid,
  metadata json,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT promotion_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT promotion_assignments_promotion_id_foreign FOREIGN KEY (promotion_id) REFERENCES public.promotions(id),
  CONSTRAINT promotion_assignments_user_id_foreign FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT promotion_assignments_booking_id_foreign FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.promotion_tour (
  promotion_id uuid NOT NULL,
  tour_id uuid NOT NULL,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT promotion_tour_pkey PRIMARY KEY (promotion_id, tour_id),
  CONSTRAINT promotion_tour_promotion_id_foreign FOREIGN KEY (promotion_id) REFERENCES public.promotions(id),
  CONSTRAINT promotion_tour_tour_id_foreign FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.promotions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  discount_type text NOT NULL CHECK (discount_type = ANY (ARRAY['percent'::text, 'percentage'::text, 'fixed'::text])),
  value numeric NOT NULL,
  max_usage integer,
  valid_from date,
  valid_to date,
  is_active boolean DEFAULT true,
  partner_id uuid,
  tour_id uuid,
  auto_apply boolean NOT NULL DEFAULT false,
  description text,
  type character varying NOT NULL DEFAULT 'voucher'::character varying,
  auto_issue_on_cancel boolean NOT NULL DEFAULT false,
  CONSTRAINT promotions_pkey PRIMARY KEY (id),
  CONSTRAINT promotions_partner_id_foreign FOREIGN KEY (partner_id) REFERENCES public.partners(id),
  CONSTRAINT promotions_tour_id_foreign FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.recent_tour_views (
  id uuid NOT NULL,
  user_id uuid NOT NULL,
  tour_id uuid NOT NULL,
  viewed_at timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
  view_count integer NOT NULL DEFAULT 1,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT recent_tour_views_pkey PRIMARY KEY (id),
  CONSTRAINT recent_tour_views_user_id_foreign FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT recent_tour_views_tour_id_foreign FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.recommendation_embeddings (
  id uuid NOT NULL,
  entity_type character varying NOT NULL,
  entity_id uuid NOT NULL,
  vector json NOT NULL,
  extra json,
  generated_at timestamp without time zone NOT NULL,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT recommendation_embeddings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.recommendation_features (
  id uuid NOT NULL,
  tour_id uuid NOT NULL UNIQUE,
  features json NOT NULL,
  calculated_at timestamp without time zone NOT NULL,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT recommendation_features_pkey PRIMARY KEY (id),
  CONSTRAINT recommendation_features_tour_id_foreign FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.recommendation_popularities (
  id uuid NOT NULL,
  tour_id uuid NOT NULL,
  bookings_count integer NOT NULL DEFAULT 0,
  wishlist_count integer NOT NULL DEFAULT 0,
  views_count integer NOT NULL DEFAULT 0,
  score double precision NOT NULL DEFAULT '0'::double precision,
  window character varying NOT NULL DEFAULT 'overall'::character varying,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT recommendation_popularities_pkey PRIMARY KEY (id),
  CONSTRAINT recommendation_popularities_tour_id_foreign FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.refund_requests (
  id uuid NOT NULL,
  booking_id uuid NOT NULL,
  user_id uuid NOT NULL,
  partner_id uuid NOT NULL,
  status character varying NOT NULL DEFAULT 'pending_partner'::character varying,
  amount numeric NOT NULL,
  currency character varying NOT NULL DEFAULT 'VND'::character varying,
  bank_account_name character varying NOT NULL,
  bank_account_number character varying NOT NULL,
  bank_name character varying NOT NULL,
  bank_branch character varying,
  customer_message text,
  partner_message text,
  proof_url character varying,
  partner_marked_at timestamp without time zone,
  customer_confirmed_at timestamp without time zone,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT refund_requests_pkey PRIMARY KEY (id),
  CONSTRAINT refund_requests_booking_id_foreign FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT refund_requests_user_id_foreign FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT refund_requests_partner_id_foreign FOREIGN KEY (partner_id) REFERENCES public.partners(id)
);
CREATE TABLE public.reviews (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  booking_id uuid,
  user_id uuid,
  rating integer CHECK (rating >= 1 AND rating <= 5),
  comment text,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT reviews_pkey PRIMARY KEY (id),
  CONSTRAINT reviews_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id),
  CONSTRAINT reviews_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.sepay_transactions (
  id bigint NOT NULL DEFAULT nextval('sepay_transactions_id_seq'::regclass),
  gateway character varying NOT NULL,
  transactionDate character varying NOT NULL,
  accountNumber character varying NOT NULL,
  subAccount character varying,
  code character varying,
  content character varying NOT NULL,
  transferType character varying NOT NULL,
  description character varying,
  transferAmount bigint NOT NULL,
  referenceCode character varying,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT sepay_transactions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.social_accounts (
  id uuid NOT NULL,
  user_id uuid NOT NULL,
  provider character varying NOT NULL,
  provider_user_id character varying NOT NULL,
  email character varying,
  access_token text,
  refresh_token text,
  token_expires_at timestamp without time zone,
  meta json,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT social_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT social_accounts_user_id_foreign FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.support_tickets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  booking_id uuid,
  subject text NOT NULL,
  message text NOT NULL,
  status text DEFAULT 'open'::text CHECK (status = ANY (ARRAY['open'::text, 'in_progress'::text, 'resolved'::text, 'closed'::text])),
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT support_tickets_pkey PRIMARY KEY (id),
  CONSTRAINT support_tickets_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT support_tickets_booking_id_fkey FOREIGN KEY (booking_id) REFERENCES public.bookings(id)
);
CREATE TABLE public.tour_categories (
  tour_id uuid NOT NULL,
  category_id uuid NOT NULL,
  CONSTRAINT tour_categories_pkey PRIMARY KEY (tour_id, category_id),
  CONSTRAINT tour_categories_tour_id_fkey FOREIGN KEY (tour_id) REFERENCES public.tours(id),
  CONSTRAINT tour_categories_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(id)
);
CREATE TABLE public.tour_packages (
  id uuid NOT NULL,
  tour_id uuid NOT NULL,
  name character varying NOT NULL,
  description text,
  adult_price numeric NOT NULL,
  child_price numeric NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT tour_packages_pkey PRIMARY KEY (id),
  CONSTRAINT tour_packages_tour_id_foreign FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.tour_schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tour_id uuid,
  start_date date NOT NULL,
  end_date date NOT NULL,
  seats_total integer NOT NULL,
  seats_available integer NOT NULL,
  season_price numeric,
  min_participants integer,
  CONSTRAINT tour_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT tour_schedules_tour_id_fkey FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.tours (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  partner_id uuid,
  title text NOT NULL,
  description text,
  destination text,
  duration integer,
  base_price numeric,
  policy text,
  tags ARRAY,
  media jsonb,
  itinerary jsonb,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text])),
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  type character varying NOT NULL DEFAULT 'domestic'::character varying,
  child_age_limit smallint NOT NULL DEFAULT '12'::smallint,
  requires_passport boolean NOT NULL DEFAULT false,
  requires_visa boolean NOT NULL DEFAULT false,
  CONSTRAINT tours_pkey PRIMARY KEY (id),
  CONSTRAINT tours_partner_id_fkey FOREIGN KEY (partner_id) REFERENCES public.partners(id)
);
CREATE TABLE public.user_activity_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  tour_id uuid,
  action text NOT NULL CHECK (action = ANY (ARRAY['view'::text, 'search'::text, 'click'::text, 'wishlist'::text, 'book'::text])),
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT user_activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT user_activity_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_activity_logs_tour_id_fkey FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);
CREATE TABLE public.user_otps (
  id uuid NOT NULL,
  channel character varying NOT NULL,
  value character varying NOT NULL,
  otp character varying NOT NULL,
  attempts smallint NOT NULL DEFAULT '0'::smallint,
  expires_at timestamp without time zone NOT NULL,
  verified_at timestamp without time zone,
  sent_by character varying,
  ip_address inet,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT user_otps_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_recommendations (
  id uuid NOT NULL,
  user_id uuid NOT NULL UNIQUE,
  recommendations json NOT NULL,
  generated_at timestamp without time zone NOT NULL,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT user_recommendations_pkey PRIMARY KEY (id),
  CONSTRAINT user_recommendations_user_id_foreign FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  email text NOT NULL UNIQUE,
  phone text,
  password text,
  role text NOT NULL DEFAULT 'customer'::text CHECK (role = ANY (ARRAY['customer'::text, 'partner'::text, 'admin'::text])),
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  email_verified_at timestamp with time zone,
  phone_verified_at timestamp with time zone,
  status text DEFAULT 'active'::text,
  gender text,
  address text,
  notifications_enabled boolean NOT NULL DEFAULT true,
  address_line1 character varying,
  address_line2 character varying,
  city character varying,
  state character varying,
  postal_code character varying,
  country character varying,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.wishlists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  tour_id uuid,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT wishlists_pkey PRIMARY KEY (id),
  CONSTRAINT wishlists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT wishlists_tour_id_fkey FOREIGN KEY (tour_id) REFERENCES public.tours(id)
);