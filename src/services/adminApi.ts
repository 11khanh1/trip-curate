import { apiClient, extractData } from "@/lib/api-client";

// --- Types ---

export interface DashboardMetrics {
  visits_24h?: number;
  new_registrations?: number;
  new_users?: number;
  bookings?: number;
  tour_bookings?: number;
  conversion_rate?: number;
  [key: string]: unknown;
}

export interface DashboardOperations {
  pending_orders?: number;
  orders_pending?: number;
  support_requests?: number;
  pending_support?: number;
  pending_partners?: number;
  partners_pending?: number;
  [key: string]: unknown;
}

export interface DashboardBooking {
  id?: string | number;
  customer_name?: string;
  customer?: string;
  tour_name?: string;
  tour?: string;
  amount?: number;
  revenue?: string | number;
  booked_at?: string;
  time?: string;
  [key: string]: unknown;
}

export interface DashboardTrafficSource {
  channel?: string;
  name?: string;
  sessions?: number | string;
  value?: number | string;
  change?: string;
  delta?: string;
  [key: string]: unknown;
}

export interface DashboardKpi {
  title: string;
  label?: string;
  value: string;
  note?: string;
  description?: string;
  [key: string]: unknown;
}

export interface DashboardResponse {
  metrics?: DashboardMetrics;
  operations?: DashboardOperations;
  recent_bookings?: DashboardBooking[];
  bookings?: DashboardBooking[];
  traffic_sources?: DashboardTrafficSource[];
  traffic?: DashboardTrafficSource[];
  kpis?: DashboardKpi[];
  key_metrics?: DashboardKpi[];
  raw?: unknown;
  [key: string]: unknown;
}

// Users
export interface AdminUser {
  id: string | number;
  name: string;
  email: string;
  phone?: string;
  created_at?: string;
  total_bookings?: number;
  orders_count?: number;
  status?: "active" | "locked" | "disabled" | string;
  [key: string]: unknown;
}

export interface AdminUsersParams {
  role?: string;
  status?: string;
  search?: string;
  page?: number;
  per_page?: number;
}

// Partners
export type PartnerStatus = "pending" | "approved" | "rejected";

export interface AdminPartner {
  id: string | number;
  company_name: string;
  tax_code?: string | null;
  address?: string | null;
  status?: PartnerStatus | string;
  user?: {
    id: string | number;
    name: string;
    email: string;
    phone?: string | null;
    status?: string;
  };
  stats?: {
    tours_count?: number;
    bookings_count?: number;
  };
  tours_count?: number;
  bookings_count?: number;
  created_at?: string;
  [key: string]: unknown;
}

export interface PartnerPayload {
  name: string;
  email: string;
  phone?: string;
  password: string;
  password_confirmation: string;
  company_name: string;
  tax_code?: string | null;
  address?: string | null;
  status: PartnerStatus;
}

export interface AdminPartnersParams {
  status?: PartnerStatus | string;
  search?: string;
  page?: number;
  per_page?: number;
}

export interface PartnerUpdatePayload {
  company_name?: string;
  tax_code?: string | null;
  address?: string | null;
  status?: PartnerStatus;
  name?: string;
  email?: string;
  phone?: string;
}

// Tours
export type AdminTourStatus = "pending" | "approved" | "rejected";

export interface AdminTour {
  id: string;
  name: string;
  code?: string;
  slug?: string;
  status?: AdminTourStatus | string;
  partner?: AdminPartner;
  partner_id?: string | number;
  price?: number;
  currency?: string;
  location?: string;
  category?: string;
  duration?: string;
  start_date?: string;
  end_date?: string;
  created_at?: string;
  updated_at?: string;
  thumbnail_url?: string | null;
  [key: string]: unknown;
}

export interface AdminTourParams {
  status?: AdminTourStatus | string;
  search?: string;
  partner_id?: string | number;
  page?: number;
  per_page?: number;
}

// Categories
export interface AdminCategory {
  id: string;
  name: string;
  slug?: string | null;
  parent_id?: string | null;
  parent?: {
    id: string;
    name: string;
  } | null;
  [key: string]: unknown;
}

export interface CategoryPayload {
  name: string;
  slug?: string | null;
  parent_id?: string | null;
}

// Promotions
export interface AdminPromotion {
  id: string | number;
  code: string;
  discount_type: "percent" | "percentage" | "fixed" | string;
  value: number;
  max_usage?: number;
  valid_from?: string;
  valid_to?: string;
  is_active?: boolean;
  used?: number;
  [key: string]: unknown;
}

export interface PromotionPayload {
  code: string;
  discount_type: "percent" | "percentage" | "fixed";
  value: number;
  max_usage?: number | null;
  valid_from?: string | null;
  valid_to?: string | null;
  is_active?: boolean;
}

export interface PromotionUpdatePayload {
  discount_type?: "percent" | "percentage" | "fixed";
  value?: number;
  max_usage?: number | null;
  valid_from?: string | null;
  valid_to?: string | null;
  is_active?: boolean;
}

// Staff
export interface AdminStaff {
  id: string;
  name: string;
  email: string;
  phone?: string;
  role?: string;
  status?: string;
  last_login_at?: string;
  [key: string]: unknown;
}

export interface StaffPayload {
  name: string;
  email: string;
  phone?: string;
  password: string;
  password_confirmation: string;
  status?: "active" | "inactive" | "suspended";
}

export interface StaffUpdatePayload {
  name?: string;
  email?: string;
  phone?: string;
  password?: string;
  password_confirmation?: string;
  status?: "active" | "inactive" | "suspended";
}

// --- API helpers ---

export async function fetchAdminDashboard(): Promise<DashboardResponse> {
  const res = await apiClient.get("/admin/dashboard");
  const data = extractData<DashboardResponse>(res);
  data.raw = res.data;
  return data;
}

export async function fetchAdminUsers(params: AdminUsersParams = {}): Promise<PaginatedResponse<AdminUser>> {
  const res = await apiClient.get("/admin/users", { params });
  return extractPaginated<AdminUser>(res);
}

export async function fetchAdminUser(id: string | number): Promise<AdminUser> {
  const res = await apiClient.get(`/admin/users/${id}`);
  return extractData<AdminUser>(res);
}

export type AdminUserStatus = "active" | "inactive";

export async function patchAdminUserStatus(id: string | number, status: AdminUserStatus) {
  const res = await apiClient.patch(`/admin/users/${id}/status`, { status });
  return extractData(res);
}

export async function fetchAdminPartners(params: AdminPartnersParams = {}): Promise<PaginatedResponse<AdminPartner>> {
  const query: Record<string, unknown> = {};

  if (params.page !== undefined) query.page = params.page;
  if (params.per_page !== undefined) query.per_page = params.per_page;
  if (params.status !== undefined && params.status !== "") query.status = params.status;

  if (params.search !== undefined) {
    const trimmed = params.search?.trim();
    if (trimmed) {
      query.search = trimmed;
    }
  }

  const res = await apiClient.get("/admin/partners", { params: query });
  return extractPaginated<AdminPartner>(res);
}

export interface AdminPartnerDetail {
  partner: AdminPartner;
  stats?: {
    tours_count?: number;
    bookings_count?: number;
    [key: string]: unknown;
  };
  [key: string]: unknown;
}

export async function fetchAdminPartner(id: string | number): Promise<AdminPartnerDetail> {
  const res = await apiClient.get(`/admin/partners/${id}`);
  return extractData<AdminPartnerDetail>(res);
}

const sanitizeOptionalString = (value: string | null | undefined) => {
  if (value === undefined) return undefined;
  if (value === null) return null;
  const trimmed = value.trim();
  return trimmed.length > 0 ? trimmed : null;
};

const sanitizeRequiredString = (value: string) => value.trim();

export async function createAdminPartner(payload: PartnerPayload) {
  const body: Record<string, unknown> = {
    name: sanitizeRequiredString(payload.name),
    email: sanitizeRequiredString(payload.email),
    password: payload.password,
    password_confirmation: payload.password_confirmation,
    company_name: sanitizeRequiredString(payload.company_name),
    status: payload.status,
  };

  const phone = sanitizeOptionalString(payload.phone);
  if (phone !== undefined) body.phone = phone;

  body.tax_code = sanitizeOptionalString(payload.tax_code) ?? null;
  body.address = sanitizeOptionalString(payload.address) ?? null;

  const res = await apiClient.post("/admin/partners", body);
  return extractData(res);
}

export async function updateAdminPartner(id: string | number, payload: PartnerUpdatePayload) {
  const body: Record<string, unknown> = {};

  if (payload.company_name !== undefined) {
    const companyName = sanitizeOptionalString(payload.company_name);
    body.company_name = companyName ?? null;
  }
  if (payload.tax_code !== undefined) {
    body.tax_code = sanitizeOptionalString(payload.tax_code) ?? null;
  }
  if (payload.address !== undefined) {
    body.address = sanitizeOptionalString(payload.address) ?? null;
  }
  if (payload.status !== undefined) {
    body.status = payload.status;
  }
  if (payload.name !== undefined) {
    body.name = sanitizeOptionalString(payload.name);
  }
  if (payload.email !== undefined) {
    body.email = sanitizeOptionalString(payload.email);
  }
  if (payload.phone !== undefined) {
    body.phone = sanitizeOptionalString(payload.phone);
  }

  const res = await apiClient.patch(`/admin/partners/${id}`, body);
  return extractData(res);
}

export async function updateAdminPartnerStatus(id: string | number, status: PartnerStatus) {
  return updateAdminPartner(id, { status });
}

export interface AdminTourSchedule {
  id?: string | number;
  title?: string;
  start_date?: string;
  end_date?: string;
  capacity?: number;
  slots_available?: number;
  price?: number;
  notes?: string | null;
  [key: string]: unknown;
}

export interface AdminTourDetail extends AdminTour {
  schedules?: AdminTourSchedule[];
}

export async function fetchAdminTours(params: AdminTourParams = {}): Promise<PaginatedResponse<AdminTour>> {
  const query: Record<string, unknown> = {};

  if (params.page !== undefined) query.page = params.page;
  if (params.per_page !== undefined) query.per_page = params.per_page;

  if (params.status !== undefined) {
    const status = String(params.status).trim();
    if (status.length > 0) {
      query.status = status;
    }
  }

  if (params.partner_id !== undefined && params.partner_id !== null && params.partner_id !== "") {
    query.partner_id = params.partner_id;
  }

  if (params.search !== undefined) {
    const trimmed = params.search?.toString().trim();
    if (trimmed) {
      query.search = trimmed;
    }
  }

  const res = await apiClient.get("/admin/tours", { params: query });
  return extractPaginated<AdminTour>(res);
}

export async function fetchAdminTour(id: string | number): Promise<AdminTourDetail> {
  const res = await apiClient.get(`/admin/tours/${id}`);
  return extractData<AdminTourDetail>(res);
}

export async function updateAdminTourStatus(id: string, status: AdminTourStatus) {
  const res = await apiClient.patch(`/admin/tours/${id}/status`, { status });
  return extractData(res);
}



export async function fetchAdminCategories(params?: { page?: number; per_page?: number }): Promise<PaginatedResponse<AdminCategory>> {
  const res = await apiClient.get("/admin/categories", { params });
  return extractPaginated<AdminCategory>(res);
}

export async function createAdminCategory(payload: CategoryPayload) {
  const body: Record<string, unknown> = {
    name: payload.name,
    parent_id: payload.parent_id ?? null,
  };
  const slug = payload.slug?.trim();
  if (slug) {
    body.slug = slug;
  }
  const res = await apiClient.post("/admin/categories", body);
  return extractData(res);
}

export async function updateAdminCategory(id: string | number, payload: CategoryPayload) {
  const body: Record<string, unknown> = {};
  if (payload.name !== undefined) body.name = payload.name;
  if (payload.parent_id !== undefined) body.parent_id = payload.parent_id ?? null;
  if (payload.slug !== undefined) {
    const slug = payload.slug?.trim();
    body.slug = slug && slug.length > 0 ? slug : null;
  }
  const res = await apiClient.put(`/admin/categories/${id}`, body);
  return extractData(res);
}

export async function deleteAdminCategory(id: string | number) {
  const res = await apiClient.delete(`/admin/categories/${id}`);
  return extractData(res);
}

export interface PaginatedResponse<T> {
  data: T[];
  links?: Record<string, unknown>;
  meta?: Record<string, unknown>;
}

function extractPaginated<T>(res: any): PaginatedResponse<T> {
  const json = res?.data ?? res;
  if (!json) return { data: [] };
  if (Array.isArray(json)) return { data: json };
  return {
    data: Array.isArray(json.data) ? (json.data as T[]) : [],
    links: json.links,
    meta: json.meta,
  };
}

export async function fetchAdminPromotions(params?: { page?: number; per_page?: number }): Promise<PaginatedResponse<AdminPromotion>> {
  const res = await apiClient.get("/admin/promotions", { params });
  return extractPaginated<AdminPromotion>(res);
}

export async function createAdminPromotion(payload: PromotionPayload) {
  const res = await apiClient.post("/admin/promotions", payload);
  return extractData(res);
}

export async function updateAdminPromotion(id: string | number, payload: PromotionUpdatePayload) {
  const res = await apiClient.put(`/admin/promotions/${id}`, payload);
  return extractData(res);
}

export async function deleteAdminPromotion(id: string | number) {
  const res = await apiClient.delete(`/admin/promotions/${id}`);
  return extractData(res);
}

export async function fetchAdminStaff(params?: { page?: number; per_page?: number; status?: string }): Promise<PaginatedResponse<AdminStaff>> {
  const res = await apiClient.get("/admin/staff", { params });
  return extractPaginated<AdminStaff>(res);
}

export async function createAdminStaff(payload: StaffPayload) {
  const body: Record<string, unknown> = {
    name: payload.name,
    email: payload.email,
    phone: payload.phone ?? null,
    password: payload.password,
    password_confirmation: payload.password_confirmation,
  };
  if (payload.status) {
    body.status = payload.status;
  }
  const res = await apiClient.post("/admin/staff", body);
  return extractData(res);
}

export async function updateAdminStaff(id: string, payload: StaffUpdatePayload) {
  const body: Record<string, unknown> = {};
  if (payload.name !== undefined) body.name = payload.name;
  if (payload.email !== undefined) body.email = payload.email;
  if (payload.phone !== undefined) body.phone = payload.phone ?? null;
  if (payload.password !== undefined) body.password = payload.password;
  if (payload.password_confirmation !== undefined) {
    body.password_confirmation = payload.password_confirmation;
  }
  if (payload.status !== undefined) body.status = payload.status;
  const res = await apiClient.put(`/admin/staff/${id}`, body);
  return extractData(res);
}

export async function deleteAdminStaff(id: string) {
  const res = await apiClient.delete(`/admin/staff/${id}`);
  return extractData(res);
}
